
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Image Processing and Basic Segmentation &#8212; QI 2024 Analysis Lab Manual</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Lab02_Image_Processing_and_Basic_Detection';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
   
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/image001.png" class="logo__image only-light" alt="QI 2024 Analysis Lab Manual - Home"/>
    <script>document.write(`<img src="_static/image001.png" class="logo__image only-dark" alt="QI 2024 Analysis Lab Manual - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Welcome to QI 2024
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Lab03_Image_Correction_and_Intensity_Measurements.html">Image Correction and Intensity Measurements</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lab04_ML-based_Segmentation_and_Classification.html">Segmentation and Pixel Classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lab05_DL4MIA_Zero_N2V_StarDist_CellPose2.html">Deep Learning for Microscopy Image Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lab06_3D_Image_Analysis.html">3D Image Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lab07_Image_Time_Series_Analysis.html">Image Time Series Analysis</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Additional Resources</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="bibliography.html">Bibliography</a></li>
<li class="toctree-l1"><a class="reference internal" href="genindex.html">Index</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/bethac07/qi_2024_analysis_lab_manual" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/bethac07/qi_2024_analysis_lab_manual/edit/main/qi_2024_analysis_lab_manual/Lab02_Image_Processing_and_Basic_Detection.md" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/bethac07/qi_2024_analysis_lab_manual/issues/new?title=Issue%20on%20page%20%2FLab02_Image_Processing_and_Basic_Detection.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/Lab02_Image_Processing_and_Basic_Detection.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Image Processing and Basic Segmentation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-objectives">Learning Objectives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#edge-filtering-edge-detection"><strong>Edge Filtering &amp; Edge Detection</strong></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#edge-detection-in-fiji">Edge detection in Fiji</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#edge-detection-in-cellprofiler">Edge detection in CellProfiler</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#log-filtering">LoG filtering</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#canny-edge-detection">Canny edge detection</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-segmentation"><strong>Basic Segmentation</strong></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-files">Load files</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#smooth-the-images-and-find-local-maxima">Smooth the images and find local maxima</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#threshold-and-fill-holes-in-the-threshold-masks">Threshold and fill holes in the threshold masks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#watershed-into-objects-and-fill-holes-in-the-object-masks">Watershed into objects, and fill holes in the object masks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluate-your-performance-across-multiple-images">Evaluate your performance across multiple images</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bonus-exercises-filtering"><strong>Bonus Exercises - Filtering</strong></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bonus-exercise-steerable-filtering-and-ridge-detection">Bonus Exercise: Steerable Filtering and Ridge Detection</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-thresholding">Basic thresholding</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#steerable-filtering">Steerable Filtering</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bonus-exercise-image-filtering-in-harder-data">Bonus Exercise: Image filtering in harder data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bonus-exercises-segmentation"><strong>Bonus Exercises - Segmentation</strong></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bonus-exercise-encapsulating-all-of-segmentation-into-one-module">Bonus Exercise: Encapsulating all of segmentation into one module</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bonus-exercise-using-seeded-watershed-to-build-cells-from-nuclei">Bonus Exercise: Using seeded watershed to build Cells from Nuclei</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#even-harder-segmentation">Even harder segmentation</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="image-processing-and-basic-segmentation">
<h1>Image Processing and Basic Segmentation<a class="headerlink" href="#image-processing-and-basic-segmentation" title="Link to this heading">#</a></h1>
<p><em>Lab authors: Hunter Elliott, Marcelo Cicconet, &amp; Beth Cimini</em> .</p>
<p><small>This file last updated 2024-04-05.</small></p>
<hr class="docutils" />
<section id="learning-objectives">
<h2>Learning Objectives<a class="headerlink" href="#learning-objectives" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Experimenting with filtering</p></li>
<li><p>Get experience with CellProfiler<span id="id1">[<a class="reference internal" href="bibliography.html#id5" title="David R Stirling, Madison J Swain-Bowden, Alice M Lucas, Anne E Carpenter, Beth A Cimini, and Allen Goodman. CellProfiler 4: improvements in speed, utility and usability. BMC Bioinformatics, 22(1):433, September 2021.">7</a>]</span></p></li>
<li><p>Bonus: Detecting edges and ridges</p></li>
<li><p>Bonus: Using encapsulated segmentation modules in CellProfiler</p></li>
</ul>
<p>Lab Data: <a class="reference external" href="https://tinyurl.com/qi2024labs"><u>https://tinyurl.com/qi2024labs</u></a></p>
</section>
<hr class="docutils" />
<section id="edge-filtering-edge-detection">
<h2><strong>Edge Filtering &amp; Edge Detection</strong><a class="headerlink" href="#edge-filtering-edge-detection" title="Link to this heading">#</a></h2>
<p><em>The goal here is to detect at least some of the edges between the cells
using what you’ve learned about derivative filters.</em></p>
<section id="edge-detection-in-fiji">
<h3>Edge detection in Fiji<a class="headerlink" href="#edge-detection-in-fiji" title="Link to this heading">#</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You will need to have the FeatureJ plugin installed for these exercises. If it’s not, check the first analysis lab handout for instructions on how to do it. |</p>
</div>
<ul class="simple">
<li><p>Open the <code class="docutils literal notranslate"><span class="pre">Image_Processing/Neurons/4_9_13_AVG_Aligned_Stack</span></code>.tif image</p>
<ul>
<li><p>Why will thresholding not work on this image?</p></li>
</ul>
</li>
<li><p>Experiment with first partial derivatives:</p>
<ul>
<li><p>Go to Plugins-&gt;FeatureJ-&gt;FeatureJ derivatives</p></li>
<li><p>Which order derivative will detect edges? Select this order
derivative in the X direction and look at the result - why does this
make sense?</p></li>
<li><p>Do the same in the Y direction, and compare which features in the
image are highlighted.</p></li>
<li><p>Adjust the “smoothing scale” parameter and see how the result
changes. What is this setting doing to the filter kernel?</p></li>
</ul>
</li>
<li><p>Experiment with edge filtering</p>
<ul>
<li><p>Go to Plugins-&gt;FeatureJ-&gt;FeatureJ Edges</p></li>
<li><p>Make sure only the “compute gradient magnitude image” box is
checked, select a “smoothing scale” and then click OK. Look at the
resulting image and compare to the original image and the partial
derivatives you calculated before.</p></li>
<li><p>Try different smoothing scales - which features produce the
strongest response at larger scales? At smaller scales?</p></li>
</ul>
</li>
<li><p>Experiment with edge detection</p>
<ul>
<li><p>Go to Plugins-&gt;FeatureJ-&gt;FeatureJ Edges</p></li>
<li><p>Check the “suppress non-maximum gradients” box and click OK. Look at
the resulting image, and compare it to the previous edge filter
image - how is it different?</p></li>
<li><p>Experiment with thresholding the non-maximum suppressed edge
filtered image (Ctrl+Shift+T). Examine the values in the non-maximum
suppressed edge image, and then decide on a good high and low
threshold for edge detection. Then re-run the FeatureJ edges plugin,
typing these thresholds into the lower and higher threshold boxes to
perform Canny edge detection.</p></li>
<li><p>Look at your result. Overlay it on the original image. Where did
your edge detector succeed? Where did it fail?</p></li>
</ul>
</li>
</ul>
</section>
<hr class="docutils" />
<section id="edge-detection-in-cellprofiler">
<h3>Edge detection in CellProfiler<a class="headerlink" href="#edge-detection-in-cellprofiler" title="Link to this heading">#</a></h3>
<section id="log-filtering">
<h4>LoG filtering<a class="headerlink" href="#log-filtering" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Open CellProfiler and load the same image (<code class="docutils literal notranslate"><span class="pre">Image_Processing/Neurons/4_9_13_AVG_Aligned_Stack</span></code>) in the Images panel (where it says <strong>Drop files and folders here</strong>)</p></li>
<li><p>Load the <code class="docutils literal notranslate"><span class="pre">edge_detection_neurons.cppipe</span></code> pipeline file onto the left side pipeline panel (where it says <strong>Drop a pipeline file here</strong>)</p></li>
<li><p>Enter test mode by hitting the <code class="docutils literal notranslate"><span class="pre">Start</span> <span class="pre">Test</span> <span class="pre">Mode</span></code> button  <a class="reference internal" href="_images/StartTestMode.png"><img alt="_images/StartTestMode.png" src="_images/StartTestMode.png" style="height: 30px;" /></a></p></li>
<li><p>Execute the <code class="docutils literal notranslate"><span class="pre">EnhanceEdges</span></code> module by hitting the <code class="docutils literal notranslate"><span class="pre">Step</span></code> button  <a class="reference internal" href="_images/Step.png"><img alt="_images/Step.png" src="_images/Step.png" style="height: 30px;" /></a></p></li>
<li><p>How does the LoG filter look? What happens when you change the Gaussian diameter size?</p></li>
</ul>
</section>
<section id="canny-edge-detection">
<h4>Canny edge detection<a class="headerlink" href="#canny-edge-detection" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Change to performing Canny edge finding by changing the selected method in <code class="docutils literal notranslate"><span class="pre">Select</span> <span class="pre">an</span> <span class="pre">edge</span> <span class="pre">finding</span> <span class="pre">method</span></code></p></li>
<li><p>Execute the module by pressing <code class="docutils literal notranslate"><span class="pre">Step</span></code> - what happens?</p></li>
<li><p>Play with manually setting your own thresholds by setting the automatic thresholding settings to <code class="docutils literal notranslate"><span class="pre">No</span></code> - are you able to find good values?</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You may find your values are approximately a factor of ~250 off from the values you were using in Fiji - can you hypothesize what might be happening here?</p>
</div>
</section>
</section>
</section>
<hr class="docutils" />
<section id="basic-segmentation">
<h2><strong>Basic Segmentation</strong><a class="headerlink" href="#basic-segmentation" title="Link to this heading">#</a></h2>
<p>As discussed in lecture, classical segmentation typically consists of a stereotyped set of steps</p>
<ol class="arabic simple">
<li><p>Smoothing</p></li>
<li><p>Thresholding</p></li>
<li><p>Filling holes in threshold masks</p></li>
<li><p>Local maxima detection in smoothed image</p></li>
<li><p>Watershed</p></li>
<li><p>Filling holes in detected objects</p></li>
</ol>
<p>Here, we will demonstrate all these steps in CellProfiler, and let you play with how the parameters you choose to see how they affect the segmentation you get.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>There are two main ways to move around in CellProfiler once in test mode - keep</p>
<ul class="simple">
<li><p>If you hit the <code class="docutils literal notranslate"><span class="pre">Step</span></code> button  <a class="reference internal" href="_images/Step.png"><img alt="_images/Step.png" src="_images/Step.png" style="height: 30px;" /></a>, the next module (but only the next module) will run</p></li>
<li><p>If you hit the <code class="docutils literal notranslate"><span class="pre">Run</span></code> button  <a class="reference internal" href="_images/Run.png"><img alt="_images/Run.png" src="_images/Run.png" style="height: 30px;" /></a>, all the remaining modules will run (unless you’ve added a pause button somewhere)</p></li>
</ul>
</div>
<section id="load-files">
<h3>Load files<a class="headerlink" href="#load-files" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Open a new CellProfiler window, or open a clean starting version by going to File -&gt; New Project</p></li>
<li><p>Load the <code class="docutils literal notranslate"><span class="pre">Basic_Segmentation</span></code> folder into the Images module as above</p>
<ul>
<li><p>This will load 3 sets of images, each with a DAPI image and and actin image</p></li>
</ul>
</li>
<li><p>Load the <code class="docutils literal notranslate"><span class="pre">basic_segmentation.cppipe</span></code> folder into the pipeline panel as above</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>CellProfiler <code class="docutils literal notranslate"><span class="pre">.cppipe</span></code> files are just text files. You can open them in a basic text editor such as Notepad to see what’s inside. It also makes them easily shareable with your labmates or even to attach as supplemental information on a paper.</p>
</div>
<ul class="simple">
<li><p>Enter test mode by hitting the <code class="docutils literal notranslate"><span class="pre">Start</span> <span class="pre">Test</span> <span class="pre">Mode</span></code> button  <a class="reference internal" href="_images/StartTestMode.png"><img alt="_images/StartTestMode.png" src="_images/StartTestMode.png" style="height: 30px;" /></a></p></li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Curious about how CellProfiler figures out that this is 3 sets of 2 channels each, and not 6 individual images or one 6 channel image? Look at the NamesAndTypes module!</p>
</div>
</section>
<section id="smooth-the-images-and-find-local-maxima">
<h3>Smooth the images and find local maxima<a class="headerlink" href="#smooth-the-images-and-find-local-maxima" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Run the <code class="docutils literal notranslate"><span class="pre">Smooth</span></code> module - without going nuts, how does your result change if you change the method? What about the smoothing diameter?</p></li>
<li><p>Run the <code class="docutils literal notranslate"><span class="pre">FindMaxima</span></code> module to find local maxima in the smoothed image created above</p>
<ul>
<li><p>You may find it helpful to increase the maxima preview size.</p></li>
<li><p>Is it clear how all of the settings control where maxima are found?</p></li>
</ul>
</li>
</ul>
</section>
<section id="threshold-and-fill-holes-in-the-threshold-masks">
<h3>Threshold and fill holes in the threshold masks<a class="headerlink" href="#threshold-and-fill-holes-in-the-threshold-masks" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Run the <code class="docutils literal notranslate"><span class="pre">Threshold</span></code> module on the smoothed image</p></li>
<li><p>Run the <code class="docutils literal notranslate"><span class="pre">RemoveHoles</span></code> module on the thresholded image to remove any holes in the masks</p>
<ul>
<li><p>If there aren’t any holes, try setting the <code class="docutils literal notranslate"><span class="pre">Threshold</span> <span class="pre">Correction</span> <span class="pre">Factor</span></code> in the <code class="docutils literal notranslate"><span class="pre">Threshold</span></code> module to something like 1.1 or 1.2 (from 1.0) to create some</p>
<ul>
<li><p>What do you think that setting may do, mathematically?</p></li>
<li><p>Click the help button (<a class="reference internal" href="_images/Info.png"><img alt="_images/Info.png" src="_images/Info.png" style="height: 25px;" /></a>) to learn if you were right.</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</section>
<section id="watershed-into-objects-and-fill-holes-in-the-object-masks">
<h3>Watershed into objects, and fill holes in the object masks<a class="headerlink" href="#watershed-into-objects-and-fill-holes-in-the-object-masks" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Run the <code class="docutils literal notranslate"><span class="pre">Watershed</span></code> module to turn your masks into actual CellProfiler objects</p></li>
<li><p>Run the <code class="docutils literal notranslate"><span class="pre">FillObjects</span></code> module to remove any holes that may remain in the objects themselves</p></li>
</ul>
</section>
<section id="evaluate-your-performance-across-multiple-images">
<h3>Evaluate your performance across multiple images<a class="headerlink" href="#evaluate-your-performance-across-multiple-images" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>It is <strong><em>critical</em></strong> when doing segmentation to evaluate your objects against your raw images - otherwise, you cannot be certain your preprocessing steps have not introduced errors. Run the <code class="docutils literal notranslate"><span class="pre">OverlayOutlines</span></code> module to see how you did.</p>
<ul>
<li><p>If not well, where do you think you need to make changes?</p></li>
</ul>
</li>
<li><p>It is also <strong><em>critical</em></strong> to see if your settings work well across not just one image, but all of your images. Evaluate your performance on all 3 image sets.</p></li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>To move between image sets in CellProfiler, use the <code class="docutils literal notranslate"><span class="pre">NextImageSet</span></code> button  <a class="reference internal" href="_images/NextImageSet.png"><img alt="_images/NextImageSet.png" src="_images/NextImageSet.png" style="height: 30px;" /></a></p>
</div>
<ul class="simple">
<li><p>If your performance is not equal across all 3, in what ways?</p></li>
<li><p>If your perfomance is not equal across all 3, is there anything you notice about the ones where it does vs does not perform well?</p></li>
<li><p>Were there modules you thought were superfluous for one image set but ended up helping for another?</p></li>
</ul>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>How do you know when your segmentation is “good enough”? It’s a SUPER common but a very complicated question! You can check out <a class="reference external" href="https://zenodo.org/doi/10.5281/zenodo.10498984">this blog post</a> for one attempte at helping come up with a set of rules for making that decision.</p>
</div>
</section>
</section>
<hr class="docutils" />
<section id="bonus-exercises-filtering">
<h2><strong>Bonus Exercises - Filtering</strong><a class="headerlink" href="#bonus-exercises-filtering" title="Link to this heading">#</a></h2>
<section id="bonus-exercise-steerable-filtering-and-ridge-detection">
<h3>Bonus Exercise: Steerable Filtering and Ridge Detection<a class="headerlink" href="#bonus-exercise-steerable-filtering-and-ridge-detection" title="Link to this heading">#</a></h3>
<p><em>In this section, you will segment microtubules by using filters to
accentuate “ridge-like” structures in the image.</em></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For this exercise, you’ll need a plug-in (SteerableJ) that runs on an older version of ImageJ. Please launch <code class="docutils literal notranslate"><span class="pre">ImageJ_SteerableJ_Win/ImageJ.exe</span></code> (or <code class="docutils literal notranslate"><span class="pre">ImageJ_SteerableJ_Mac/ImageJ.app</span></code> if you’re on a Mac), available with the data for this lab. Or you can follow these instructions: <a class="reference external" href="http://bigwww.epfl.ch/demo/steerable/download.html"><u>http://bigwww.epfl.ch/demo/steerable/download.html</u></a></p>
</div>
<section id="basic-thresholding">
<h4>Basic thresholding<a class="headerlink" href="#basic-thresholding" title="Link to this heading">#</a></h4>
<p><em>First, try segmenting the microtubules with simple thresholding (for
comparison to steerable filters)</em></p>
<ul class="simple">
<li><p>Load one of the images from <code class="docutils literal notranslate"><span class="pre">Image_Processing/Microtubules/easy</span></code> into ImageJ</p></li>
<li><p>Subtract the background (Process &gt; Subtract Background…). To view the
background image, select “Create background (don’t subtract)”, and
“Preview”. What is a good choice for the length scale (radius)?
Deselect these and press OK. Why is background subtraction important
for basic thresholding?</p></li>
<li><p>Threshold the image. You can test this out manually (Image &gt; Adjust
&gt; Threshold…). Is there a threshold that will accurately segment the
microtubules?</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="steerable-filtering">
<h4>Steerable Filtering<a class="headerlink" href="#steerable-filtering" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Re-load the image in ImageJ</p></li>
<li><p>Launch SteerableJ (Plugins &gt; SteerableJ). There are multiple
parameters that can be tuned:</p>
<ul>
<li><p><em>order:</em> Do you want to use an even or an odd order? Hint: look at
the image of the filter kernel in the top left panel. Note: Higher
order filters are more selective for orientation.</p></li>
<li><p><em>mu:</em> This parameter controls the sensitivity of the filter. A
higher value makes the filter less prone to false positives, but
also reduces localization precision.</p></li>
<li><p><em>sigma:</em> This is the scale of your structure. Match this to the size
(width) of the ridges in your image.</p></li>
</ul>
</li>
<li><p>After tuning your parameters, press ‘Run’.</p></li>
<li><p>Now try thresholding the filtered image. Is it easier to find a good
threshold?</p></li>
<li><p>The SteerableJ plug-in has a button to “Refine Features” which will
further clean up the image by applying non-maximum suppression. Press
‘Refine features’ to view this output.</p></li>
<li><p>Steerable filters are designed to be sensitive to the orientation of
detected features. The initial output is a projection, which displays
only the magnitude of the filter response, not its orientation. Press
‘Show Orientation’ to view the orientation of maximal response of the
filter. To view the raw data associated with this image, press
‘Display rotation’. Every slice in this z-stack is the response at a
particular orientation. How could you use this to filter lines of a
given orientation?</p></li>
</ul>
<p><em>References:</em></p>
<p><span id="id2">Freeman and Adelson [<a class="reference internal" href="bibliography.html#id3" title="W.T. Freeman and E.H. Adelson. The design and use of steerable filters. IEEE Transactions on Pattern Analysis and Machine Intelligence, 13(9):891-906, 1991. doi:10.1109/34.93808.">8</a>]</span></p>
<p><span id="id3">Jacob and Unser [<a class="reference internal" href="bibliography.html#id4" title="M. Jacob and M. Unser. Design of steerable filters for feature detection using canny-like criteria. IEEE Transactions on Pattern Analysis and Machine Intelligence, 26(8):1007-1019, 2004. doi:10.1109/TPAMI.2004.44.">9</a>]</span></p>
</section>
</section>
<section id="bonus-exercise-image-filtering-in-harder-data">
<h3>Bonus Exercise: Image filtering in harder data<a class="headerlink" href="#bonus-exercise-image-filtering-in-harder-data" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Use what you’ve learned to attempt to outline the cell <em>and</em> its
nucleus in the image <code class="docutils literal notranslate"><span class="pre">Image_Processing/Cells/Nadia</span> <span class="pre">20131122_RhoAMEFs_18kPa_001_w477_t01.tif</span></code></p>
<ul>
<li><p>What filter is appropriate here - an edge or a ridge filter?</p></li>
</ul>
</li>
<li><p>Use what you’ve learned to detect some of the red and green isolated
axons in the image <code class="docutils literal notranslate"><span class="pre">Image_Processing/Neurons/arpy01_Chat_082_B_i_cropped.tif</span></code> while
avoiding both the large mass of continuous red fluorescence near the
injection site, and the autofluorescence of the cell bodies in green.
(You will not need the blue DNA channel)</p></li>
</ul>
</section>
</section>
<section id="bonus-exercises-segmentation">
<h2><strong>Bonus Exercises - Segmentation</strong><a class="headerlink" href="#bonus-exercises-segmentation" title="Link to this heading">#</a></h2>
<section id="bonus-exercise-encapsulating-all-of-segmentation-into-one-module">
<h3>Bonus Exercise: Encapsulating all of segmentation into one module<a class="headerlink" href="#bonus-exercise-encapsulating-all-of-segmentation-into-one-module" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>At the end of your segmentation piepeline, you’ll see two modules that are there but inactive - they have an empty checkbox <a class="reference internal" href="_images/InactivatedModule.png"><img alt="_images/InactivatedModule.png" src="_images/InactivatedModule.png" style="height: 20px;" /></a> . Click this box to enable the <code class="docutils literal notranslate"><span class="pre">IdentifyPrimaryObjects</span></code> module - it should now look like this: <a class="reference internal" href="_images/Check.png"><img alt="_images/Check.png" src="_images/Check.png" style="height: 20px;" /></a></p></li>
<li><p>Run the IdentifyPrimaryObjects module - how does it do at identifying your nuclei directly from the DNA image?</p></li>
<li><p>Under the hood, IdentifyPrimaryObjects is doing all the steps we previously did, plus some filtering out of objects based on criteria you set (like whether they touch the edge). Can you <code class="docutils literal notranslate"><span class="pre">Identify</span></code> (😉) which setting corresponds to each of our previous steps?</p></li>
</ul>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Two of the steps are combined in a single setting!</p>
</div>
</section>
<section id="bonus-exercise-using-seeded-watershed-to-build-cells-from-nuclei">
<h3>Bonus Exercise: Using seeded watershed to build Cells from Nuclei<a class="headerlink" href="#bonus-exercise-using-seeded-watershed-to-build-cells-from-nuclei" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>After you’ve enabled IdentifyPrimaryObjects, you can also enable IdentifySecondaryObjects, which is designed to take an initial, smaller, internal object (nearly always a nucleus) and build a larger object around it (nearly always a cell). Enable and run this module.</p></li>
<li><p>What settings correspond to our segmentation steps, as in IdentifyPrimary?</p></li>
<li><p>Are there any settings that are new? Click the help button (<a class="reference internal" href="_images/Info.png"><img alt="_images/Info.png" src="_images/Info.png" style="height: 25px;" /></a>) to learn about what these do and how they work.</p></li>
</ul>
</section>
<section id="even-harder-segmentation">
<h3>Even harder segmentation<a class="headerlink" href="#even-harder-segmentation" title="Link to this heading">#</a></h3>
<p>Nuclei are relatively easy to segment relative to cells - they are bright, fairly uniform, and often reasonably well spaced.
How well can conventional segmentation work on cells, and how easily can it be done?</p>
<ul class="simple">
<li><p>Download the <code class="docutils literal notranslate"><span class="pre">DL4MIA/hard/train</span></code> <a class="reference external" href="https://tinyurl.com/qi2024labs"><u>https://tinyurl.com/qi2024labs</u></a></p></li>
<li><p>Start a new CellProfiler project (or open a new CellProfiler window) and drag and drop that folder of images into the Images panel</p></li>
<li><p>Drag and drop the <code class="docutils literal notranslate"><span class="pre">advanced_untuned.cppipe</span></code> file into the CellProfiler pipeline panel. Other than the input module settings, no segmentation settings have been tuned at all in this pipeline.</p></li>
<li><p>Try to create an accurate segmentation of these cells - you will want to turn the advanced settings on. How well can you do? What settings seem to make the most difference?</p></li>
</ul>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Here is what an experienced image analyst came up with - so at least this level of accuracy is possible!
<img alt="_images/CellProfiler_AdvancedIDP.png" src="_images/CellProfiler_AdvancedIDP.png" /></p>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-objectives">Learning Objectives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#edge-filtering-edge-detection"><strong>Edge Filtering &amp; Edge Detection</strong></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#edge-detection-in-fiji">Edge detection in Fiji</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#edge-detection-in-cellprofiler">Edge detection in CellProfiler</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#log-filtering">LoG filtering</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#canny-edge-detection">Canny edge detection</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-segmentation"><strong>Basic Segmentation</strong></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-files">Load files</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#smooth-the-images-and-find-local-maxima">Smooth the images and find local maxima</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#threshold-and-fill-holes-in-the-threshold-masks">Threshold and fill holes in the threshold masks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#watershed-into-objects-and-fill-holes-in-the-object-masks">Watershed into objects, and fill holes in the object masks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluate-your-performance-across-multiple-images">Evaluate your performance across multiple images</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bonus-exercises-filtering"><strong>Bonus Exercises - Filtering</strong></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bonus-exercise-steerable-filtering-and-ridge-detection">Bonus Exercise: Steerable Filtering and Ridge Detection</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-thresholding">Basic thresholding</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#steerable-filtering">Steerable Filtering</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bonus-exercise-image-filtering-in-harder-data">Bonus Exercise: Image filtering in harder data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bonus-exercises-segmentation"><strong>Bonus Exercises - Segmentation</strong></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bonus-exercise-encapsulating-all-of-segmentation-into-one-module">Bonus Exercise: Encapsulating all of segmentation into one module</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bonus-exercise-using-seeded-watershed-to-build-cells-from-nuclei">Bonus Exercise: Using seeded watershed to build Cells from Nuclei</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#even-harder-segmentation">Even harder segmentation</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By QI 2024
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>